name: Build Apps

on:
  push:
    branches: [main]
  workflow_dispatch: # Manuel tetikleme

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Tesseract OCR
        run: |
          brew install tesseract
          # Arapça dil paketi indir
          curl -L -o /opt/homebrew/share/tessdata/ara.traineddata https://github.com/tesseract-ocr/tessdata/raw/main/ara.traineddata

      - name: Install Python dependencies
        run: |
          pip install flet pyinstaller pymupdf opencv-python numpy Pillow pytesseract

      - name: Prepare Tesseract for bundling
        run: |
          mkdir -p tesseract_bundle/tessdata
          # Tesseract binary
          cp /opt/homebrew/bin/tesseract tesseract_bundle/
          chmod +x tesseract_bundle/tesseract
          # Tessdata
          cp /opt/homebrew/share/tessdata/*.traineddata tesseract_bundle/tessdata/

      - name: Build Mac App
        run: |
          flet pack app.py --name "PDFTemizleyiciMAC" \
            --add-data "pdf_processor.py:." \
            --add-data "image_cleaner.py:." \
            --add-data "tesseract_bundle:tesseract_bundle"

      - name: Upload Mac App
        uses: actions/upload-artifact@v4
        with:
          name: PDFTemizleyiciMAC
          path: dist/PDFTemizleyiciMAC.app

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Tesseract OCR via Chocolatey
        run: |
          choco install tesseract -y
          # Arapça dil paketi indir
          Invoke-WebRequest -Uri "https://github.com/tesseract-ocr/tessdata/raw/main/ara.traineddata" -OutFile "C:\Program Files\Tesseract-OCR\tessdata\ara.traineddata"

      - name: Install Python dependencies
        run: |
          pip install flet pyinstaller pymupdf opencv-python numpy Pillow pytesseract

      - name: Prepare Tesseract for bundling
        run: |
          mkdir tesseract_bundle
          # Tesseract dizinini kopyala
          xcopy "C:\Program Files\Tesseract-OCR\*" tesseract_bundle\ /E /I /H

      - name: Build Windows App
        run: |
          flet pack app.py --name "PDFTemizleyiciWINDOWS" --add-data "pdf_processor.py;." --add-data "image_cleaner.py;." --add-data "tesseract_bundle;tesseract_bundle"

      - name: Upload Windows App
        uses: actions/upload-artifact@v4
        with:
          name: PDFTemizleyiciWINDOWS
          path: dist/PDFTemizleyiciWINDOWS.exe
